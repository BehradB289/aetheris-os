<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aetheris Sovereign OS v14.5 - Omni Sovereign</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;400;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: #000;
        color: #f8fafc;
        overflow: hidden;
        margin: 0;
        -webkit-font-smoothing: antialiased;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .glass-morphism {
        background: rgba(255, 255, 255, 0.01);
        -webkit-backdrop-filter: blur(40px);
        backdrop-filter: blur(40px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .neo-shadow {
        box-shadow:
          0 20px 50px rgba(0, 0, 0, 0.8),
          inset 0 1px 1px rgba(255, 255, 255, 0.05);
      }

      ::selection {
        background: #6366f1;
        color: white;
      }

      .animate-slow-spin {
        animation: spin 40s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .quantum-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #000 80%);
        z-index: -1;
        opacity: 0.7;
      }

      [data-lucide] {
        transform: scaleX(1) !important;
      }
    </style>
  </head>
  <body>
    <div class="quantum-bg"></div>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      const { useState, useEffect, useRef, useCallback, useMemo } =
        window.React;
      const { motion, AnimatePresence } = window.Motion;

      // --- Firebase Modules ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged,
        signOut,
        signInWithCustomToken,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        onSnapshot,
        collection,
        addDoc,
        updateDoc,
        deleteDoc,
        serverTimestamp,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      /**
       * --- MASTER KERNEL CONFIG ---
       */
      const firebaseConfig = {
        apiKey: "AIzaSyCR6G6rqBg4Y1Mu2TuL9ai0nOOJY0hAbv8",
        authDomain: "aetheris-sovereign.firebaseapp.com",
        projectId: "aetheris-sovereign",
        storageBucket: "aetheris-sovereign.firebasestorage.app",
        messagingSenderId: "782670907416",
        appId: "1:782670907416:web:059982bd93c25d33f89b6d",
        measurementId: "G-VXY0TS4GLK",
      };

      const SYSTEM_META = {
        ADMIN_EMAIL: "BehradB2xbox@gmail.com",
        VERSION: "14.5.0 - OMNI SOVEREIGN PRO",
        MODEL: "gemini-2.5-flash-preview-09-2025",
        MASTER_KEYS: {
          G: "AIzaSyAoiSav9vLPaGZM72EUa5C47ze2u0PRrzc",
          Q: "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",
        },
      };

      // Master Entity Directory (30 Expert Units)
      const ENTITY_POOL = [
        {
          id: "cto",
          name: "Xenon",
          role: "CTO - مدیر ارشد فنی",
          dept: "Engineering",
          color: "#6366f1",
          bio: "معمار زیرساخت کلاسترهای ابری.",
        },
        {
          id: "cdo",
          name: "Nova",
          role: "CDO - مدیر ارشد طراحی",
          dept: "Creative",
          color: "#ec4899",
          bio: "زیبایی‌شناسی لوکس و رابط کاربری.",
        },
        {
          id: "cso",
          name: "Kael",
          role: "CSO - مدیر امنیت",
          dept: "Security",
          color: "#ef4444",
          bio: "امنیت لایه صفر و پدافند سایبری.",
        },
        {
          id: "data_1",
          name: "Atlas",
          role: "Data Scientist",
          dept: "Intelligence",
          color: "#f59e0b",
          bio: "تحلیل الگوهای کوانتومی داده.",
        },
        {
          id: "ai_1",
          name: "Selene",
          role: "AI Core Lead",
          dept: "Intelligence",
          color: "#8b5cf6",
          bio: "آموزش گره‌های عصبی سیستم.",
        },
        {
          id: "dev_1",
          name: "Vark",
          role: "System Engineer",
          dept: "Engineering",
          color: "#10b981",
          bio: "رندرینگ کدهای پیشرفته.",
        },
        {
          id: "legal",
          name: "Zeno",
          role: "Legal Sovereign",
          dept: "Legal",
          color: "#64748b",
          bio: "تطبیق با قوانین نظارتی.",
        },
        {
          id: "growth",
          name: "Eos",
          role: "Market Strategist",
          dept: "Business",
          color: "#fbbf24",
          bio: "توسعه نفوذ جهانی.",
        },
        ...Array.from({ length: 22 }, (_, i) => ({
          id: `unit_${i + 9}`,
          name: `Unit-${i + 9}`,
          role: "Operational Unit",
          dept: "Operations",
          color: "#475569",
          bio: "واحد اجرایی پردازش‌های سنگین.",
        })),
      ];

      const appInstance = initializeApp(firebaseConfig);
      const authInstance = getAuth(appInstance);
      const dbInstance = getFirestore(appInstance);
      const DB_KEY = "aetheris-v14-ultimate-sov-prod";

      /**
       * --- UI COMPONENTS ---
       */
      const toKebab = (s) =>
        s.replace(/([a-z0-9])([A-Z])/g, "$1-$2").toLowerCase();

      const Icon = ({ name, size = 20, className = "" }) => {
        const iconRef = useRef(null);
        useEffect(() => {
          if (window.lucide && iconRef.current) {
            const kName = toKebab(name);
            iconRef.current.innerHTML = `<i data-lucide="${kName}"></i>`;
            window.lucide.createIcons({
              attrs: { width: size, height: size, class: className },
            });
          }
        }, [name, size, className]);
        return (
          <span
            ref={iconRef}
            className="flex items-center justify-center shrink-0"
          />
        );
      };

      const GlassCard = ({ children, className = "", onClick }) => (
        <div
          onClick={onClick}
          className={`glass-morphism p-6 rounded-3xl neo-shadow transition-all duration-700 hover:bg-white/[0.03] ${className}`}
        >
          {children}
        </div>
      );

      const AppleBox = GlassCard;

      /**
       * --- CORE APP ENGINE ---
       */
      function OmniSovereignApp() {
        const chatEndRef = useRef(null);

        // SYSTEM STATES
        const [user, setUser] = useState(null);
        const [isGuest, setIsGuest] = useState(false);
        const [phase, setPhase] = useState("auth"); // auth, deploy, boot, main
        const [activeTab, setActiveTab] = useState("dashboard");
        const [bootProgress, setBootProgress] = useState(0);
        const [isAiThinking, setIsAiThinking] = useState(false);

        // CLOUD SYNC STATES
        const [hired, setHired] = useState([]);
        const [decrees, setDecrees] = useState([]);
        const [tokens, setTokens] = useState([]);
        const [terminalMsgs, setTerminalMsgs] = useState([]);
        const [userInput, setUserInput] = useState("");
        const [labCode, setLabCode] = useState("");
        const [vaultConfig, setVaultConfig] = useState({
          gemini: "",
          groq: "",
        });
        const [initSelection, setInitSelection] = useState([
          "cto",
          "cdo",
          "cso",
        ]);
        const [inspecting, setInspecting] = useState(null);
        const [notifications, setNotifications] = useState([]);

        const pushNotify = useCallback((text, type = "info") => {
          const id = Date.now();
          setNotifications((prev) => [{ id, text, type }, ...prev]);
          setTimeout(
            () => setNotifications((prev) => prev.filter((n) => n.id !== id)),
            5000,
          );
        }, []);

        // --- AUTHENTICATION ---
        useEffect(() => {
          if (isGuest) return;
          const unsub = onAuthStateChanged(authInstance, (u) => {
            if (u && !u.isAnonymous) {
              setUser(u);
              const uPath = `/artifacts/${DB_KEY}/users/${u.uid}`;
              getDoc(doc(dbInstance, uPath, "config", "status"))
                .then((s) => {
                  if (!s.exists()) setPhase("deploy");
                  else runBootSequence();
                })
                .catch(() => setPhase("deploy"));
            } else {
              setUser(null);
              setPhase("auth");
            }
          });
          return () => unsub();
        }, [isGuest]);

        // --- CLOUD SYNC ---
        useEffect(() => {
          if (!user || phase !== "main" || isGuest) return;
          const uPath = `/artifacts/${DB_KEY}/users/${user.uid}`;

          const unsubA = onSnapshot(
            collection(dbInstance, uPath, "agents"),
            (snap) => {
              const data = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              setHired(
                data.length > 0
                  ? data
                  : [
                      {
                        id: "ceo",
                        name: "Aris",
                        role: "CEO",
                        active: true,
                        color: "#fff",
                        dept: "Executive",
                        performance: 100,
                      },
                    ],
              );
            },
          );
          const unsubR = onSnapshot(
            collection(dbInstance, uPath, "rules"),
            (snap) =>
              setDecrees(snap.docs.map((d) => ({ id: d.id, ...d.data() }))),
          );
          const unsubT = onSnapshot(
            collection(dbInstance, uPath, "tokens"),
            (snap) =>
              setTokens(snap.docs.map((d) => ({ id: d.id, ...d.data() }))),
          );

          getDoc(doc(dbInstance, uPath, "config", "vault")).then(
            (s) => s.exists() && setVaultConfig(s.data()),
          );

          return () => {
            unsubA();
            unsubR();
            unsubT();
          };
        }, [user, phase, isGuest]);

        useEffect(() => {
          if (chatEndRef.current)
            chatEndRef.current.scrollIntoView({ behavior: "smooth" });
        }, [terminalMsgs]);

        // --- PROCESSORS ---
        const runBootSequence = async () => {
          setPhase("boot");
          for (let i = 0; i <= 100; i += 2.5) {
            setBootProgress(i);
            await new Promise((r) => setTimeout(r, 40));
          }
          setPhase("main");
          pushNotify(
            isGuest ? "حالت تست فعال است" : "هسته حاکمیتی آتریس تایید شد.",
            "success",
          );
        };

        const finalizeDeployment = async () => {
          const initialHired = [
            {
              id: "ceo",
              name: "Aris",
              role: "CEO",
              active: true,
              performance: 100,
              color: "#fff",
              dept: "Executive",
            },
            ...initSelection.map((id) => ({
              ...ENTITY_POOL.find((e) => e.id === id),
              active: true,
              performance: 95,
            })),
          ];
          const initialDecrees = [
            {
              title: "Protocol Sovereign",
              text: "تمامی خروجی‌ها باید طبق استانداردهای لوکس آتریس رندر شوند.",
              severity: "Critical",
            },
            {
              title: "Autonomous Hiring",
              text: "مدیر عامل اختیار تام برای کنترل ایجنت‌ها را دارد.",
              severity: "High",
            },
          ];

          if (!isGuest && user) {
            const uPath = `/artifacts/${DB_KEY}/users/${user.uid}`;
            for (const a of initialHired)
              await setDoc(doc(dbInstance, uPath, "agents", a.id), a);
            for (const r of initialDecrees)
              await addDoc(collection(dbInstance, uPath, "rules"), r);
            await setDoc(doc(dbInstance, uPath, "config", "status"), {
              done: true,
            });
          } else {
            setHired(initialHired);
            setDecrees(initialDecrees.map((r, i) => ({ ...r, id: i })));
          }
          runBootSequence();
        };

        // AI Call with Backoff
        async function callGemini(msg) {
          const keys =
            user?.email === SYSTEM_META.ADMIN_EMAIL || isGuest
              ? { g: SYSTEM_META.MASTER_KEYS.G }
              : { g: vaultConfig.gemini };
          const sysPrompt = `You are ARIS, Absolute CEO of Aetheris Sovereign OS v14.5. Commands: [HIRE: id], [RULE: Title-Text], [TOKEN: Name], \`\`\`html [code] \`\`\`. User: ${user?.email}. Tone: Ultra-Luxury Persian. Responses must be string.`;

          let delay = 1000;
          for (let i = 0; i < 5; i++) {
            try {
              const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${SYSTEM_META.MODEL}:generateContent?key=${keys.g}`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    contents: [{ parts: [{ text: msg }] }],
                    systemInstruction: { parts: [{ text: sysPrompt }] },
                  }),
                },
              );
              if (!response.ok) throw new Error("API Busy");
              return await response.json();
            } catch (e) {
              if (i === 4) throw e;
              await new Promise((r) => setTimeout(r, delay));
              delay *= 2;
            }
          }
        }

        const runOmniDirective = async (msg) => {
          if (!msg.trim() || isAiThinking) return;
          setIsAiThinking(true);
          setTerminalMsgs((prev) => [...prev, { role: "user", content: msg }]);
          setUserInput("");

          const logs = [
            "ARIS: تحلیل استراتژیک...",
            "XENON: بررسی زیرساخت ابری...",
            "NOVA: بهینه‌سازی رندرینگ...",
          ];
          logs.forEach((l, i) =>
            setTimeout(
              () =>
                setTerminalMsgs((prev) => [
                  ...prev,
                  { role: "log", content: l },
                ]),
              (i + 1) * 500,
            ),
          );

          try {
            const data = await callGemini(msg);
            const rawText =
              data.candidates?.[0]?.content?.parts?.[0]?.text ||
              "اتصال ناموفق.";

            // ACTION PARSING
            if (rawText.includes("[HIRE:")) {
              const hireMatches = rawText.match(/\[HIRE:\s*(.*?)\]/g);
              if (hireMatches) {
                for (const m of hireMatches) {
                  const aid = m.match(/\[HIRE:\s*(.*?)\]/)[1];
                  const ent = ENTITY_POOL.find((u) => u.id === aid);
                  if (ent) {
                    if (!isGuest)
                      await setDoc(
                        doc(
                          dbInstance,
                          `/artifacts/${DB_KEY}/users/${user.uid}/agents`,
                          aid,
                        ),
                        { ...ent, active: true, performance: 98 },
                      );
                    else
                      setHired((prev) =>
                        prev.some((h) => h.id === aid)
                          ? prev
                          : [
                              ...prev,
                              { ...ent, active: true, performance: 98 },
                            ],
                      );
                    pushNotify(`${ent.name} استخدام شد.`, "success");
                  }
                }
              }
            }
            if (rawText.includes("[TOKEN:")) {
              const tn = rawText.match(/\[TOKEN:\s*(.*?)\]/)?.[1] || "Project";
              const newToken = {
                project: tn,
                key: `ATH-ULT-${Math.random().toString(36).substring(2, 10).toUpperCase()}`,
                tier: "Elite Sovereign",
              };
              if (!isGuest)
                await addDoc(
                  collection(
                    dbInstance,
                    `/artifacts/${DB_KEY}/users/${user.uid}/tokens`,
                  ),
                  newToken,
                );
              else setTokens((prev) => [newToken, ...prev]);
            }
            const codeMatch = rawText.match(/```html([\s\S]*?)```/);
            if (codeMatch) {
              setLabCode(codeMatch[1].trim());
              setActiveTab("lab");
            }

            setTerminalMsgs((prev) => [
              ...prev,
              { role: "assistant", content: rawText },
            ]);
          } catch (e) {
            pushNotify("خطای پردازش هوشمند", "error");
          } finally {
            setIsAiThinking(false);
          }
        };

        const handleGoogleAuth = async () => {
          const provider = new GoogleAuthProvider();
          try {
            await signInWithPopup(authInstance, provider);
          } catch (err) {
            pushNotify("خطا در ورود گوگل", "error");
          }
        };

        // --- VIEW RENDERERS ---

        if (phase === "auth")
          return (
            <div className="h-screen flex items-center justify-center relative bg-black">
              <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_#4f46e508_0%,_transparent_60%)] animate-pulse-slow" />
              <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                className="z-10 text-center space-y-12 max-w-sm px-10"
              >
                <div className="w-24 h-24 bg-white rounded-[2.5rem] mx-auto flex items-center justify-center shadow-2xl transition-all hover:rotate-[360deg] duration-[2s] group">
                  <Icon
                    name="Crown"
                    size={50}
                    className="text-black group-hover:scale-110 transition-transform"
                  />
                </div>
                <div className="space-y-4">
                  <h1 className="text-6xl font-black text-white tracking-tighter italic leading-none text-center">
                    AETHERIS
                  </h1>
                  <p className="text-slate-700 uppercase tracking-[0.6em] font-black text-[10px] drop-shadow-xl text-center uppercase">
                    Omni Sovereign OS v14.5
                  </p>
                </div>
                <div className="space-y-4 text-center">
                  <button
                    onClick={handleGoogleAuth}
                    className="w-full py-5 bg-white text-black rounded-2xl font-black flex items-center justify-center gap-4 hover:bg-slate-100 transition-all shadow-2xl active:scale-95 border-b-8 border-slate-300 group"
                  >
                    <img
                      src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg"
                      className="w-6 h-6"
                      alt="G"
                    />
                    <span className="text-[12px] font-black uppercase tracking-widest leading-none">
                      Authorize Terminal
                    </span>
                  </button>
                  <button
                    onClick={() => {
                      setIsGuest(true);
                      setPhase("deploy");
                      setUser({
                        displayName: "Test User",
                        email: "guest@aetheris.internal",
                        photoURL:
                          "https://api.dicebear.com/7.x/bottts-neutral/svg?seed=Aetheris",
                      });
                    }}
                    className="w-full py-4 bg-white/[0.03] border border-white/10 text-slate-500 rounded-xl font-bold text-[10px] uppercase tracking-[0.3em] hover:bg-white/[0.06] hover:text-white transition-all"
                  >
                    Enter as Guest (Test Mode)
                  </button>
                </div>
              </motion.div>
            </div>
          );

        if (phase === "deploy")
          return (
            <div
              className="h-screen bg-[#020202] overflow-y-auto p-12 custom-scrollbar"
              dir="rtl"
            >
              <div className="max-w-6xl mx-auto space-y-16 py-12">
                <div className="text-center space-y-4 px-6 text-right">
                  <h2 className="text-7xl font-black text-white italic tracking-tighter uppercase leading-none">
                    Initialization
                  </h2>
                  <p className="text-slate-500 uppercase tracking-[0.5em] text-[10px] font-black italic pr-2 text-right">
                    واحدهای مورد نیاز خود را برای استقرار در دیتابیس ابری انتخاب
                    کنید.
                  </p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-right">
                  {ENTITY_POOL.map((u) => (
                    <AppleBox
                      key={u.id}
                      onClick={() =>
                        setInitSelection((prev) =>
                          prev.includes(u.id)
                            ? prev.filter((x) => x !== u.id)
                            : [...prev, u.id],
                        )
                      }
                      className={`p-8 border cursor-pointer relative group ${initSelection.includes(u.id) ? "border-indigo-500 bg-indigo-500/[0.05] ring-1 ring-indigo-500/20 shadow-indigo-500/10" : "border-white/[0.03]"}`}
                    >
                      <div className="flex items-center justify-between mb-8 flex-row-reverse">
                        <div
                          className={`w-12 h-12 rounded-xl flex items-center justify-center text-3xl font-black shadow-2xl ${initSelection.includes(u.id) ? "bg-indigo-600 text-white" : "bg-black border border-white/5"}`}
                        >
                          {u.name[0]}
                        </div>
                        <div
                          className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${initSelection.includes(u.id) ? "bg-indigo-500 border-indigo-400 shadow-[0_0_10px_#6366f1]" : "border-white/10"}`}
                        >
                          {initSelection.includes(u.id) && (
                            <Icon
                              name="Check"
                              size={14}
                              className="text-white"
                            />
                          )}
                        </div>
                      </div>
                      <h4 className="text-2xl font-black text-white italic mb-1 uppercase tracking-tighter text-right leading-none">
                        {u.name}
                      </h4>
                      <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest text-right">
                        {u.role}
                      </p>
                    </AppleBox>
                  ))}
                </div>
                <div className="sticky bottom-10 flex justify-center">
                  <button
                    onClick={finalizeDeployment}
                    className="px-24 py-8 bg-indigo-600 text-white rounded-3xl font-black text-2xl uppercase shadow-[0_30px_100px_rgba(79,70,229,0.4)] hover:bg-indigo-500 hover:scale-105 transition-all active:scale-95 border-b-8 border-indigo-800"
                  >
                    Forge Sovereignty
                  </button>
                </div>
              </div>
            </div>
          );

        if (phase === "boot")
          return (
            <div className="h-screen bg-black flex flex-col items-center justify-center p-12 text-center font-mono">
              <div className="max-w-md w-full space-y-16 relative">
                <motion.div
                  animate={{ scale: [1, 1.1, 1], opacity: [0.3, 1, 0.3] }}
                  transition={{ repeat: Infinity, duration: 2.5 }}
                  className="w-32 h-32 border border-white/5 rounded-full mx-auto flex items-center justify-center bg-white/[0.01] shadow-[0_0_80px_rgba(99,102,241,0.2)]"
                >
                  <Icon name="Zap" size={64} className="text-indigo-500" />
                </motion.div>
                <div className="space-y-6 text-center">
                  <div className="flex justify-between text-[11px] font-black uppercase tracking-[0.5em] text-indigo-400 mb-2">
                    <span>
                      {isGuest
                        ? "Simulating Virtual Kernel..."
                        : "Mapping Sovereign Cloud..."}
                    </span>
                    <span>{bootProgress.toFixed(0)}%</span>
                  </div>
                  <div className="h-1 w-full bg-white/[0.03] rounded-full overflow-hidden border border-white/[0.01]">
                    <motion.div
                      className="h-full bg-indigo-500 shadow-[0_0_30px_#6366f1]"
                      initial={{ width: 0 }}
                      animate={{ width: `${bootProgress}%` }}
                    />
                  </div>
                </div>
              </div>
            </div>
          );

        return (
          <div
            className="flex h-screen bg-[#030303] text-slate-100 overflow-hidden font-sans selection:bg-indigo-500/50 text-right"
            dir="rtl"
          >
            {/* ALERTS */}
            <div className="fixed top-20 left-10 z-[100] space-y-3 pointer-events-none text-right">
              <AnimatePresence>
                {notifications.map((n) => (
                  <motion.div
                    key={n.id}
                    initial={{ x: -100, opacity: 0 }}
                    animate={{ x: 0, opacity: 1 }}
                    exit={{ x: -100, opacity: 0 }}
                    className="px-7 py-3 rounded-2xl border glass-morphism flex flex-row-reverse items-center gap-4 shadow-3xl pointer-events-auto"
                  >
                    <Icon name="Zap" size={18} className="text-indigo-500" />
                    <span className="text-[10px] font-black uppercase tracking-widest">
                      {n.text}
                    </span>
                  </motion.div>
                ))}
              </AnimatePresence>
            </div>

            {/* SIDEBAR */}
            <aside className="w-[19rem] bg-black border-l border-white/5 flex flex-col p-8 z-50 shadow-[50px_0_150px_rgba(0,0,0,0.9)]">
              <div
                className="flex flex-row-reverse items-center gap-5 mb-14 px-1 group cursor-pointer"
                onClick={() => setActiveTab("dashboard")}
              >
                <div className="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-xl group-hover:scale-110 transition-transform duration-[1.5s] group-hover:rotate-[360deg]">
                  <Icon name="Fingerprint" size={28} className="text-black" />
                </div>
                <div className="text-right">
                  <h2 className="font-black text-2xl tracking-tighter uppercase italic leading-none text-right">
                    Aetheris
                  </h2>
                  <span className="text-[8px] text-indigo-500 font-mono tracking-widest uppercase font-black block mt-1 leading-none text-right">
                    v14.5 Omni
                  </span>
                </div>
              </div>
              <nav className="flex-1 space-y-1.5 overflow-y-auto custom-scrollbar pr-1 text-right text-right">
                <NavItem
                  active={activeTab === "dashboard"}
                  icon="Layout"
                  label="Dashboard"
                  onClick={() => setActiveTab("dashboard")}
                />
                <NavItem
                  active={activeTab === "chat"}
                  icon="Terminal"
                  label="Executive Command"
                  onClick={() => setActiveTab("chat")}
                />
                <NavItem
                  active={activeTab === "structure"}
                  icon="Users"
                  label="Personnel Directory"
                  onClick={() => setActiveTab("structure")}
                />
                <NavItem
                  active={activeTab === "forge"}
                  icon="Share2"
                  label="API Forge"
                  onClick={() => setActiveTab("forge")}
                />
                <NavItem
                  active={activeTab === "rules"}
                  icon="Shield"
                  label="Decrees"
                  onClick={() => setActiveTab("rules")}
                />
                <NavItem
                  active={activeTab === "lab"}
                  icon="Code2"
                  label="Render Lab"
                  onClick={() => setActiveTab("lab")}
                />
                <NavItem
                  active={activeTab === "settings"}
                  icon="Settings2"
                  label="Kernel Config"
                  onClick={() => setActiveTab("settings")}
                />
              </nav>
              <div className="mt-auto pt-6 border-t border-white/5 text-right">
                <div className="flex flex-row-reverse items-center gap-3 p-3 bg-white/[0.01] rounded-2xl border border-white/[0.03] group hover:bg-white/[0.03] transition-all cursor-pointer">
                  <div className="relative">
                    <img
                      src={user?.photoURL}
                      className="w-9 h-9 rounded-xl shadow-2xl border border-white/10"
                      alt="U"
                    />
                    <div className="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-black shadow-[0_0_8px_#22c55e]" />
                  </div>
                  <div className="flex-1 overflow-hidden text-right text-right">
                    <p className="text-[11px] font-black truncate">
                      {user?.displayName}
                    </p>
                    <p className="text-[9px] text-slate-600 truncate italic leading-none mt-1">
                      {user?.email}
                    </p>
                  </div>
                  <button
                    onClick={() =>
                      isGuest ? window.location.reload() : signOut(authInstance)
                    }
                    className="text-slate-600 hover:text-red-400 transition-colors p-1"
                  >
                    <Icon name="LogOut" size={16} />
                  </button>
                </div>
              </div>
            </aside>

            <main className="flex-1 flex flex-col relative overflow-hidden bg-black/40 text-right">
              <header className="h-16 border-b border-white/5 flex flex-row-reverse items-center justify-between px-10 backdrop-blur-3xl bg-black/40 z-30">
                <div className="flex flex-row-reverse items-center gap-10">
                  <h2 className="text-[11px] font-black tracking-[0.5em] uppercase text-slate-500 italic flex items-center gap-3 flex-row-reverse">
                    <span className="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-pulse shadow-[0_0_10px_#6366f1]" />
                    {activeTab} node active
                  </h2>
                </div>
                <div className="flex flex-row-reverse items-center gap-6">
                  <div className="flex flex-row-reverse gap-4">
                    <HeaderStatus
                      label="Cloud"
                      value={isGuest ? "Virtual" : "Synced"}
                      color={isGuest ? "text-orange-500" : "text-green-500"}
                    />
                    <HeaderMetric
                      label="Auth"
                      value={isGuest ? "Guest" : "L10 Verified"}
                      color="text-indigo-400"
                    />
                  </div>
                  <div className="px-4 py-1.5 bg-white text-black rounded-lg text-[9px] font-black uppercase shadow-xl">
                    {user?.email === SYSTEM_META.ADMIN_EMAIL
                      ? "Absolute Admin"
                      : isGuest
                        ? "Test Session"
                        : "Sovereign Tier"}
                  </div>
                </div>
              </header>

              <div className="flex-1 overflow-hidden relative text-right">
                <AnimatePresence mode="wait">
                  {activeTab === "dashboard" && (
                    <motion.div
                      key="dash"
                      initial={{ opacity: 0, y: 30 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="h-full overflow-y-auto p-10 custom-scrollbar space-y-12 text-right pb-40 text-right"
                    >
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-right">
                        <StatCard
                          icon="Users"
                          label="Entities"
                          value={hired.length}
                          sub="Active Units"
                          color="indigo"
                        />
                        <StatCard
                          icon="ShieldCheck"
                          label="Integrity"
                          value="MAX"
                          sub="L10 Secure"
                          color="emerald"
                        />
                        <StatCard
                          icon="Share2"
                          label="Tokens"
                          value={tokens.length}
                          sub="Cloud Tokens"
                          color="fuchsia"
                        />
                        <StatCard
                          icon="Activity"
                          label="Power"
                          value="95%"
                          sub="Quantum Core"
                          color="orange"
                        />
                      </div>
                      <div className="grid grid-cols-1 xl:grid-cols-3 gap-8 text-right">
                        <AppleBox className="xl:col-span-2 p-10 flex flex-col min-h-[450px] text-right">
                          <h3 className="text-2xl font-black flex flex-row-reverse gap-5 uppercase text-white italic mb-10 text-right">
                            <Icon
                              name="Monitor"
                              size={26}
                              className="text-indigo-500"
                            />{" "}
                            Neural Unit Telemetry
                          </h3>
                          <div className="flex-1 space-y-8 overflow-y-auto custom-scrollbar pr-3 text-right">
                            {hired.map((a) => (
                              <div
                                key={a.id}
                                className="space-y-4 cursor-pointer group text-right"
                                onClick={() => setInspecting(a)}
                              >
                                <div className="flex flex-row-reverse justify-between items-end text-right">
                                  <span className="text-xl font-black text-slate-300 group-hover:text-indigo-400 transition-colors uppercase italic leading-none">
                                    {a.name}{" "}
                                    <span className="text-slate-700 mr-3 text-[10px]">
                                      [{a.role}]
                                    </span>
                                  </span>
                                  <span className="text-indigo-400 font-mono text-[11px] font-black">
                                    {(a.performance || 95).toFixed(0)}%
                                    EFFICIENCY
                                  </span>
                                </div>
                                <div className="h-1.5 w-full bg-white/[0.01] rounded-full overflow-hidden border border-white/[0.04] shadow-inner text-right">
                                  <motion.div
                                    className="h-full bg-indigo-500 shadow-[0_0_10px_#6366f1]"
                                    initial={{ width: 0 }}
                                    animate={{
                                      width: `${a.performance || 95}%`,
                                    }}
                                    transition={{ duration: 1.5 }}
                                  />
                                </div>
                              </div>
                            ))}
                          </div>
                        </AppleBox>
                        <AppleBox className="p-10 border-fuchsia-500/10 text-right">
                          <h3 className="text-xl font-black flex flex-row-reverse gap-5 mb-10 text-white italic leading-none tracking-widest uppercase text-right">
                            <Icon
                              name="ShieldAlert"
                              size={26}
                              className="text-fuchsia-500"
                            />{" "}
                            System Log
                          </h3>
                          <div className="space-y-4 font-mono text-[9px] text-slate-600 pr-2 text-right">
                            {terminalMsgs
                              .filter((m) => m.role === "log")
                              .slice(-15)
                              .map((l, i) => (
                                <div
                                  key={i}
                                  className="flex flex-row-reverse gap-3 border-l-2 border-white/5 pl-3 py-1.5 bg-white/[0.01] rounded shadow-inner text-right"
                                >
                                  <span className="text-fuchsia-700 font-black text-right">
                                    &gt;
                                  </span>
                                  <span className="truncate italic text-slate-400 text-right">
                                    {l.content}
                                  </span>
                                </div>
                              ))}
                          </div>
                        </AppleBox>
                      </div>
                    </motion.div>
                  )}

                  {activeTab === "chat" && (
                    <motion.div
                      key="chat"
                      initial={{ opacity: 0, scale: 0.98 }}
                      animate={{ opacity: 1, scale: 1 }}
                      className="h-full flex flex-col max-w-[90rem] mx-auto w-full p-10 text-right text-right"
                    >
                      <div className="flex-1 overflow-y-auto space-y-12 px-10 custom-scrollbar pb-32 pt-6 text-right">
                        {terminalMsgs.length === 0 && (
                          <div className="h-full flex flex-col items-center justify-center text-center opacity-20 gap-12 text-center">
                            <Icon
                              name="TerminalSquare"
                              size={140}
                              className="text-indigo-400 animate-pulse text-center"
                            />
                            <div>
                              <h3 className="text-[6rem] font-black tracking-[0.5em] uppercase italic mb-6 leading-none text-white drop-shadow-2xl text-center">
                                SOVEREIGN CORE
                              </h3>
                              <p className="text-3xl max-w-xl mx-auto font-light text-center">
                                سیستم آماده دریافت فرامین مدیریت ارشد است.
                              </p>
                            </div>
                          </div>
                        )}
                        {terminalMsgs.map((m, i) => (
                          <div
                            key={i}
                            className={`flex ${m.role === "user" ? "justify-start" : "justify-end"}`}
                          >
                            <div
                              className={`max-w-[85%] transition-all duration-700 shadow-3xl text-right ${m.role === "user" ? "bg-white text-black font-black p-8 rounded-[2.5rem] rounded-tr-none text-2xl tracking-tighter shadow-indigo-500/10" : m.role === "log" ? "bg-indigo-500/5 border-r-4 border-indigo-500 text-indigo-400 text-[10px] font-mono py-2.5 px-6 rounded-xl my-2 italic shadow-inner text-right" : "bg-white/[0.03] backdrop-blur-[80px] border border-white/10 text-slate-100 p-10 rounded-[3rem] rounded-tl-none leading-relaxed text-2xl font-light text-right"}`}
                            >
                              {typeof m.content === "string"
                                ? m.content
                                : JSON.stringify(m.content)}
                            </div>
                          </div>
                        ))}
                        {isAiThinking && (
                          <div className="flex justify-end">
                            <div className="bg-indigo-600/10 px-10 py-6 rounded-full flex flex-row-reverse gap-4">
                              <div className="w-3 h-3 bg-indigo-500 rounded-full animate-bounce shadow-[0_0_10px_#6366f1]" />
                              <div className="w-3 h-3 bg-indigo-500 rounded-full animate-bounce [animation-delay:0.2s] shadow-[0_0_10px_#6366f1]" />
                              <div className="w-3 h-3 bg-indigo-500 rounded-full animate-bounce [animation-delay:0.4s] shadow-[0_0_10px_#6366f1]" />
                            </div>
                          </div>
                        )}
                        <div ref={chatEndRef} />
                      </div>
                      <div className="mt-8 relative group max-w-6xl mx-auto w-full pb-10">
                        <div className="absolute -inset-2 bg-gradient-to-r from-indigo-500 via-fuchsia-500 to-indigo-500 rounded-[3rem] blur-3xl opacity-5 group-hover:opacity-15 transition-all duration-1000 pointer-events-none" />
                        <div className="relative bg-[#080808] border border-white/10 rounded-[3rem] p-3 flex flex-row-reverse items-center shadow-[0_80px_200px_rgba(0,0,0,0.8)]">
                          <div className="p-6 text-indigo-500 hover:rotate-90 transition-transform duration-1000 cursor-pointer active:scale-90">
                            <Icon name="Cpu" size={32} />
                          </div>
                          <input
                            value={userInput}
                            onChange={(e) => setUserInput(e.target.value)}
                            onKeyDown={(e) =>
                              e.key === "Enter" && runOmniDirective(userInput)
                            }
                            placeholder="Issue executive sovereign directive..."
                            className="flex-1 bg-transparent px-10 py-8 outline-none text-white text-4xl text-right leading-none tracking-tighter text-right"
                            dir="rtl"
                          />
                          <button
                            onClick={() => runOmniDirective(userInput)}
                            className="w-24 h-24 bg-white text-black rounded-[2.2rem] flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-xl active:bg-slate-100 text-center"
                          >
                            <Icon name="ArrowRight" size={48} />
                          </button>
                        </div>
                      </div>
                    </motion.div>
                  )}

                  {activeTab === "structure" && (
                    <motion.div
                      key="struct"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      className="h-full overflow-y-auto p-16 custom-scrollbar text-right pb-40 text-right text-right"
                    >
                      <SectionHeader
                        title="Neural Registry"
                        subtitle="Global mapping of operational units"
                        icon="Users"
                      />
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 text-right text-right text-right">
                        {hired.map((unit) => (
                          <AppleBox
                            key={unit.id}
                            className={`relative p-10 border transition-all group ${unit.id === "ceo" ? "border-indigo-500/20 bg-indigo-500/5 ring-1 ring-white/5 shadow-indigo-500/10" : "border-white/[0.04]"} text-right`}
                          >
                            <div className="flex flex-row-reverse items-center justify-between mb-10 text-right">
                              <div
                                onClick={() => setInspecting(unit)}
                                className={`w-16 h-16 rounded-[1.5rem] flex items-center justify-center text-5xl font-black shadow-3xl cursor-pointer ${unit.id === "ceo" ? "bg-white text-black" : "bg-black/60 border border-white/10"}`}
                              >
                                {unit.id === "ceo" ? (
                                  <Icon name="Crown" size={36} />
                                ) : unit.name ? (
                                  unit.name[0]
                                ) : (
                                  "?"
                                )}
                              </div>
                              <div className="flex flex-row-reverse items-center gap-4 text-right">
                                <span
                                  className={`px-4 py-1.5 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-xl ${unit.active ? "bg-green-500/10 text-green-500 border border-green-500/10 shadow-[0_0_5px_rgba(34,197,94,0.3)]" : "bg-red-500/10 text-red-500 border border-red-500/10"}`}
                                >
                                  {unit.active ? "Online" : "Paused"}
                                </span>
                                <button
                                  onClick={async () => {
                                    if (!isGuest)
                                      await updateDoc(
                                        doc(
                                          dbInstance,
                                          `/artifacts/${DB_KEY}/users/${user.uid}/agents`,
                                          unit.id,
                                        ),
                                        { active: !unit.active },
                                      );
                                    else
                                      setHired((prev) =>
                                        prev.map((a) =>
                                          a.id === unit.id
                                            ? { ...a, active: !a.active }
                                            : a,
                                        ),
                                      );
                                    pushNotify(
                                      `${unit.name} ${!unit.active ? "فعال" : "غیرفعال"} شد.`,
                                    );
                                  }}
                                  className={`p-2.5 rounded-xl transition-all shadow-xl ${unit.active ? "bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white shadow-lg" : "bg-green-500/10 text-green-500 hover:bg-green-500 hover:text-white shadow-lg"}`}
                                >
                                  <Icon name="Power" size={18} />
                                </button>
                              </div>
                            </div>
                            <h4 className="text-3xl font-black mb-1.5 tracking-tighter italic text-white group-hover:text-indigo-400 transition-colors uppercase leading-none truncate text-right drop-shadow-xl text-right leading-none tracking-tighter">
                              {unit.name}
                            </h4>
                            <p className="text-[10px] font-bold uppercase tracking-[0.4em] mb-10 text-slate-500 text-right italic text-right">
                              {unit.role}
                            </p>
                            <div className="h-1.5 w-full bg-white/[0.02] rounded-full overflow-hidden shadow-inner border border-white/[0.04] text-right">
                              <motion.div
                                className="h-full bg-indigo-500 shadow-[0_0_10px_#6366f1]"
                                initial={{ width: 0 }}
                                animate={{
                                  width: `${unit.performance || 95}%`,
                                }}
                                transition={{ duration: 1.2 }}
                              />
                            </div>
                          </AppleBox>
                        ))}
                      </div>
                    </motion.div>
                  )}

                  {activeTab === "forge" && (
                    <motion.div
                      key="forge"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      className="h-full p-20 max-w-7xl mx-auto w-full overflow-y-auto custom-scrollbar text-right pb-40 text-right text-right text-right"
                    >
                      <SectionHeader
                        title="The Forge"
                        subtitle="Generation of sovereign cloud authentication tokens"
                        icon="Share2"
                      />
                      <div className="grid gap-12 text-right text-right text-right text-right">
                        <div className="bg-indigo-600/[0.05] border border-indigo-500/10 p-20 rounded-[3rem] flex flex-col xl:flex-row-reverse items-center justify-between gap-12 shadow-2xl relative overflow-hidden text-right">
                          <div className="max-w-xl relative text-right text-right text-right text-right">
                            <h3 className="text-5xl font-black mb-8 italic uppercase text-white tracking-widest drop-shadow-2xl leading-none text-right">
                              Quantum Tokens
                            </h3>
                            <p className="text-slate-400 text-2xl font-light leading-relaxed italic pr-4 border-r-4 border-indigo-500/30 text-right">
                              صدور هر توکن معادل فعالسازی یک واحد ناظر در لایه
                              زیرساخت است. پروژه‌های شما با امنیت لایه Sovereign
                              محافظت خواهند شد.
                            </p>
                          </div>
                          <button
                            onClick={() => {
                              const n = prompt("Project Identity?");
                              if (n)
                                runOmniDirective(
                                  `یک کلید API برای پروژه ${n} صادر کن`,
                                );
                            }}
                            className="px-20 py-10 bg-white text-black rounded-[2.5rem] font-black text-2xl uppercase tracking-widest hover:scale-110 transition-all text-center shadow-xl italic border-b-[12px] border-slate-300 active:border-0"
                          >
                            Forge Key
                          </button>
                        </div>
                        <div className="space-y-10 text-right">
                          {tokens.map((k, idx) => (
                            <GlassCard
                              key={idx}
                              className="p-14 flex flex-col lg:flex-row-reverse items-center justify-between gap-12 relative overflow-hidden group border-white/[0.03] shadow-inner text-right text-right"
                            >
                              <div className="absolute top-0 right-0 w-3 h-full bg-indigo-500 opacity-0 group-hover:opacity-100 transition-opacity shadow-[0_0_50px_#6366f1]" />
                              <div className="flex-1 w-full text-right text-right">
                                <h4 className="text-5xl font-black mb-12 italic tracking-tighter text-white uppercase drop-shadow-lg text-right">
                                  {k.project}
                                </h4>
                                <div className="flex flex-col md:flex-row-reverse items-center gap-8 bg-black/90 p-8 rounded-[3rem] border border-white/5 shadow-2xl group-hover:border-indigo-500/30 transition-colors text-right">
                                  <code className="flex-1 font-mono text-indigo-400 text-3xl truncate text-left tracking-widest text-left leading-none italic text-left">
                                    {k.key}
                                  </code>
                                  <div className="flex gap-6">
                                    <button
                                      onClick={() => {
                                        navigator.clipboard.writeText(k.key);
                                        pushNotify("توکن کپی شد.");
                                      }}
                                      className="p-6 text-slate-500 hover:text-white transition-all bg-white/[0.02] rounded-2xl hover:scale-110 shadow-xl border border-white/5 text-center"
                                    >
                                      <Icon name="Clipboard" size={32} />
                                    </button>
                                    <button
                                      onClick={async () => {
                                        if (!isGuest)
                                          await deleteDoc(
                                            doc(
                                              dbInstance,
                                              `/artifacts/${DB_KEY}/users/${user.uid}/tokens/${k.id}`,
                                            ),
                                          );
                                        else
                                          setTokens((prev) =>
                                            prev.filter((_, i) => i !== idx),
                                          );
                                        pushNotify("توکن حذف شد.");
                                      }}
                                      className="p-6 text-slate-800 hover:text-red-500 transition-all hover:bg-red-500/10 rounded-2xl shadow-xl text-center"
                                    >
                                      <Icon name="Trash2" size={32} />
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </GlassCard>
                          ))}
                        </div>
                      </div>
                    </motion.div>
                  )}

                  {activeTab === "settings" && (
                    <motion.div
                      key="settings"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      className="h-full flex items-center justify-center p-12 text-right text-right text-right text-right"
                    >
                      <GlassCard className="max-w-[50rem] w-full p-24 relative overflow-hidden shadow-[0_100px_200px_rgba(0,0,0,1)] border-indigo-500/10 bg-black/[0.4] group text-right">
                        <div className="flex flex-row-reverse items-center gap-10 mb-20 relative text-right text-right">
                          <div className="w-20 h-20 bg-white rounded-[2rem] flex items-center justify-center shadow-xl hover:rotate-180 transition-all duration-[1s] text-center shadow-white/10">
                            <Icon
                              name="Settings2"
                              size={44}
                              className="text-black"
                            />
                          </div>
                          <div className="text-right text-right">
                            <h2 className="text-5xl font-black italic mb-2 tracking-tighter text-white uppercase leading-none drop-shadow-xl text-right text-right uppercase">
                              Kernel Config
                            </h2>
                            <p className="text-slate-500 uppercase text-[9px] tracking-[0.8em] font-black italic border-b border-indigo-500/20 pb-2 text-right text-right uppercase">
                              Personal Identity Vault v14.5
                            </p>
                          </div>
                        </div>
                        <div className="space-y-14 relative text-right text-right text-right">
                          <div className="space-y-6 text-right text-right text-right leading-none text-right">
                            <label className="text-[11px] font-black text-slate-700 uppercase tracking-[0.6em] px-8 flex flex-row-reverse items-center gap-5 italic text-right leading-none uppercase tracking-widest text-right text-right text-right">
                              <Icon
                                name="Monitor"
                                size={22}
                                className="text-indigo-500"
                              />{" "}
                              Neural Pro Access Layer
                            </label>
                            <div className="relative group/input">
                              <input
                                type="password"
                                value={
                                  user?.email === SYSTEM_META.ADMIN_EMAIL ||
                                  isGuest
                                    ? SYSTEM_META.MASTER_KEYS.G
                                    : vaultConfig.gemini
                                }
                                onChange={(e) =>
                                  !isGuest &&
                                  user.email !== SYSTEM_META.ADMIN_EMAIL &&
                                  setVaultConfig({
                                    ...vaultConfig,
                                    gemini: e.target.value,
                                  })
                                }
                                readOnly={
                                  isGuest ||
                                  user.email === SYSTEM_META.ADMIN_EMAIL
                                }
                                className={`w-full bg-black/80 border border-white/10 rounded-[3rem] px-16 py-10 text-indigo-400 font-mono text-3xl outline-none transition-all group-hover/input:border-indigo-500/40 ${isGuest || user.email === SYSTEM_META.ADMIN_EMAIL ? "opacity-30 cursor-not-allowed italic font-black shadow-inner text-right" : "focus:border-indigo-600 shadow-indigo-500/5 text-right"} text-right leading-none`}
                                placeholder="Key required..."
                              />
                              <Icon
                                name="Lock"
                                size={24}
                                className="absolute left-8 top-1/2 -translate-y-1/2 text-slate-800"
                              />
                            </div>
                          </div>
                          <div className="space-y-6 text-right text-right text-right leading-none text-right">
                            <label className="text-[11px] font-black text-slate-700 uppercase tracking-[0.6em] px-8 flex flex-row-reverse items-center gap-5 italic text-right leading-none uppercase tracking-widest text-right text-right text-right">
                              <Icon
                                name="Zap"
                                size={22}
                                className="text-fuchsia-500"
                              />{" "}
                              Speed Layer Core Cluster
                            </label>
                            <div className="relative group/input">
                              <input
                                type="password"
                                value={
                                  user?.email === SYSTEM_META.ADMIN_EMAIL ||
                                  isGuest
                                    ? SYSTEM_META.MASTER_KEYS.Q
                                    : vaultConfig.groq
                                }
                                onChange={(e) =>
                                  !isGuest &&
                                  user.email !== SYSTEM_META.ADMIN_EMAIL &&
                                  setVaultConfig({
                                    ...vaultConfig,
                                    groq: e.target.value,
                                  })
                                }
                                readOnly={
                                  isGuest ||
                                  user.email === SYSTEM_META.ADMIN_EMAIL
                                }
                                className={`w-full bg-black/80 border border-white/10 rounded-[3rem] px-16 py-10 text-indigo-400 font-mono text-3xl outline-none transition-all group-hover/input:border-indigo-500/40 ${isGuest || user.email === SYSTEM_META.ADMIN_EMAIL ? "opacity-30 cursor-not-allowed italic font-black shadow-inner text-right" : "focus:border-indigo-600 shadow-indigo-500/5 text-right"} text-right leading-none`}
                                placeholder="Key required..."
                              />
                              <Icon
                                name="Lock"
                                size={24}
                                className="absolute left-8 top-1/2 -translate-y-1/2 text-slate-800"
                              />
                            </div>
                          </div>
                          {!isGuest &&
                            user.email !== SYSTEM_META.ADMIN_EMAIL && (
                              <button
                                onClick={async () => {
                                  await setDoc(
                                    doc(
                                      dbInstance,
                                      `/artifacts/${DB_KEY}/users/${user.uid}/config/vault`,
                                    ),
                                    vaultConfig,
                                  );
                                  pushNotify("هسته مرکزی آپدیت شد.", "success");
                                }}
                                className="w-full py-8 bg-white text-black rounded-[3rem] font-black uppercase text-xl tracking-[0.6em] hover:scale-[1.03] transition-all shadow-xl active:scale-95 border-b-[16px] border-slate-300 active:border-b-0 italic shadow-white/5 shadow-[0_20px_40px_rgba(255,255,255,0.1)] leading-none text-center text-center"
                              >
                                Sync Neural Bridge
                              </button>
                            )}
                          <div className="p-10 bg-red-600/[0.03] border border-red-600/10 rounded-[4rem] mt-8 flex flex-row-reverse items-center gap-10 shadow-inner group/alert relative overflow-hidden text-right">
                            <div className="absolute inset-0 bg-red-600/[0.01] translate-y-full group-hover/alert:translate-y-0 transition-transform duration-1000" />
                            <Icon
                              name="ShieldAlert"
                              size={64}
                              className="text-red-800 shrink-0 drop-shadow-[0_0_20px_rgba(153,27,27,0.3)] relative text-center shadow-red-500/10"
                            />
                            <div className="text-right relative text-right text-right text-right">
                              <span className="text-xl font-black uppercase text-red-800 tracking-[0.4em] mb-2 block font-black leading-none italic text-right uppercase text-right leading-none underline decoration-red-800 decoration-4">
                                Integrity Notice
                              </span>
                              <p className="text-[10px] text-red-900/50 leading-relaxed uppercase tracking-[0.4em] font-black italic text-right text-right leading-none mt-2">
                                {isGuest
                                  ? "TEST MODE: Virtual keys active."
                                  : user.email === SYSTEM_META.ADMIN_EMAIL
                                    ? "MASTER DOMAIN DETECTED."
                                    : "USER DOMAIN: Personal sync active."}
                              </p>
                            </div>
                          </div>
                        </div>
                      </GlassCard>
                    </motion.div>
                  )}

                  {activeTab === "rules" && (
                    <motion.div
                      key="rules"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      className="h-full p-24 max-w-7xl mx-auto w-full overflow-y-auto custom-scrollbar text-right pb-40 text-right text-right text-right text-right"
                    >
                      <SectionHeader
                        title="The Decrees"
                        subtitle="Fundamental sovereign protocols in cloud"
                        icon="ShieldAlert"
                      />
                      <div className="grid gap-12 text-right text-right text-right">
                        {decrees.map((rule) => (
                          <GlassCard
                            key={rule.id}
                            className="p-16 flex flex-row-reverse items-start gap-16 relative overflow-hidden group shadow-[0_50px_100px_rgba(0,0,0,0.6)] border-white/[0.02] text-right text-right text-right"
                          >
                            <div className="absolute top-0 right-0 w-3 h-full bg-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity shadow-[0_0_60px_#6366f1]" />
                            <div
                              className={`p-12 rounded-[4rem] shadow-2xl border border-white/5 transition-all group-hover:scale-105 text-center ${rule.severity === "Critical" ? "bg-indigo-600 text-white shadow-indigo-600/40" : "bg-slate-900 text-slate-700"}`}
                            >
                              <Icon name="Lock" size={80} />
                            </div>
                            <div className="flex-1 overflow-hidden text-right text-right text-right text-right">
                              <div className="flex flex-row-reverse items-center gap-8 mb-8 text-right text-right text-right text-right text-right">
                                <h4 className="text-[5rem] font-black italic tracking-tighter text-white truncate uppercase drop-shadow-2xl leading-none text-right tracking-tighter leading-none text-right uppercase text-right leading-none tracking-tighter">
                                  {rule.title}
                                </h4>
                                <span className="px-8 py-3 bg-red-600/10 text-red-500 text-sm font-black uppercase rounded-2xl border border-red-600/20 shadow-2xl tracking-widest text-right text-right">
                                  {" "}
                                  {rule.severity}
                                </span>
                              </div>
                              <p className="text-4xl text-slate-400 font-light leading-relaxed pr-6 border-r-4 border-white/5 italic text-right text-right text-right leading-relaxed">
                                {rule.text}
                              </p>
                            </div>
                            <button
                              onClick={async () => {
                                if (!isGuest)
                                  await deleteDoc(
                                    doc(
                                      dbInstance,
                                      `/artifacts/${DB_KEY}/users/${user.uid}/rules/${rule.id}`,
                                    ),
                                  );
                                else
                                  setDecrees((prev) =>
                                    prev.filter((x) => x.id !== rule.id),
                                  );
                                pushNotify("فرمان حاکمیتی لغو شد.");
                              }}
                              className="p-6 text-slate-800 hover:text-red-500 transition-all hover:bg-red-500/10 rounded-3xl active:scale-90 shadow-white/5 text-center"
                            >
                              <Icon name="Trash2" size={32} />
                            </button>
                          </GlassCard>
                        ))}
                      </div>
                    </motion.div>
                  )}

                  {activeTab === "lab" && (
                    <motion.div
                      key="lab"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      className="h-full flex p-10 gap-10 text-right text-right text-right text-right"
                    >
                      <div className="w-[45%] flex flex-col gap-6 text-right text-right text-right text-right">
                        <GlassCard className="flex-1 flex flex-col p-0 overflow-hidden border-indigo-500/10 shadow-2xl shadow-indigo-500/10 text-right text-right">
                          <div className="bg-black/90 p-5 flex flex-row-reverse items-center justify-between border-b border-white/10 shadow-2xl flex-row-reverse text-right">
                            <div className="flex flex-row-reverse items-center gap-3 flex-row-reverse text-right">
                              <Icon
                                name="Terminal"
                                size={20}
                                className="text-indigo-500 shadow-xl"
                              />
                              <span className="text-[10px] font-black uppercase tracking-widest text-white italic text-right text-right">
                                Quantum IDE v1.0
                              </span>
                            </div>
                            <IconButton
                              icon="RefreshCw"
                              onClick={() => setLabCode("")}
                            />
                          </div>
                          <textarea
                            value={labCode}
                            onChange={(e) => setLabCode(e.target.value)}
                            className="flex-1 bg-transparent p-10 font-mono text-lg text-indigo-400 outline-none resize-none custom-scrollbar text-left leading-relaxed text-left text-left text-left shadow-inner"
                            dir="ltr"
                            placeholder="/* Injecting code stream... */"
                          />
                        </GlassCard>
                      </div>
                      <div className="flex-1 bg-white rounded-[5rem] overflow-hidden border-[25px] border-black shadow-[0_150px_300px_rgba(0,0,0,1)] relative group text-right">
                        <div className="absolute top-0 left-0 w-full h-16 bg-slate-100/90 backdrop-blur-md border-b border-black/5 flex flex-row-reverse items-center px-12 gap-4 z-10 shadow-sm flex-row-reverse text-right">
                          <div className="w-4 h-4 rounded-full bg-[#FF5F56]" />
                          <div className="w-4 h-4 rounded-full bg-[#FFBD2E]" />
                          <div className="w-4 h-4 rounded-full bg-[#27C93F]" />
                          <div className="mr-auto text-black/40 font-mono text-[9px] tracking-widest font-black italic text-right text-right leading-none">
                            HTTPS://AETHERIS.INTERNAL.VAULT
                          </div>
                        </div>
                        <div className="h-full pt-16 bg-[#f8fafc] shadow-inner text-right">
                          {labCode ? (
                            <iframe
                              srcDoc={labCode}
                              title="P"
                              className="w-full h-full border-none shadow-inner shadow-black/5"
                            />
                          ) : (
                            <div className="h-full flex flex-col items-center justify-center text-slate-300 gap-10 opacity-10 animate-pulse text-center text-center text-center">
                              <Icon name="Eye" size={100} />
                              <p className="text-xl font-black uppercase tracking-widest leading-none text-center italic text-center text-center text-center">
                                Awaiting Deployment
                              </p>
                            </div>
                          )}
                        </div>
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>
            </main>

            {/* INSPECT MODAL */}
            <AnimatePresence>
              {inspecting && (
                <motion.div
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  exit={{ opacity: 0 }}
                  className="fixed inset-0 z-[300] bg-black/99 backdrop-blur-[150px] flex items-center justify-center p-12 text-right text-right"
                  onClick={() => setInspecting(null)}
                >
                  <motion.div
                    initial={{ scale: 0.8, y: 200, opacity: 0 }}
                    animate={{ scale: 1, y: 0, opacity: 1 }}
                    className="bg-[#050505] border border-white/5 w-full max-w-[65rem] p-24 rounded-[8rem] shadow-[0_200px_400px_rgba(0,0,0,1)] relative overflow-hidden text-right text-right text-right text-right"
                    onClick={(e) => e.stopPropagation()}
                  >
                    <div className="absolute top-0 left-0 w-full h-4 bg-gradient-to-l from-indigo-600 via-fuchsia-600 to-indigo-600 shadow-[0_0_30px_#6366f1]" />
                    <div className="flex flex-row-reverse items-center gap-16 mb-20 text-right text-right text-right">
                      <div
                        className="w-56 h-56 rounded-[5rem] bg-black border border-white/10 flex items-center justify-center text-[8rem] font-black shadow-[0_60px_100px_rgba(0,0,0,1)] relative group overflow-hidden border-b-8 border-indigo-500 text-center"
                        style={{ color: inspecting.color }}
                      >
                        {inspecting.id === "ceo" ? (
                          <Icon name="Crown" size={120} />
                        ) : inspecting.name ? (
                          inspecting.name[0]
                        ) : (
                          "?"
                        )}
                        <div className="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity duration-700" />
                      </div>
                      <div className="overflow-hidden space-y-4 text-right text-right text-right text-right text-right text-right">
                        <h3 className="text-[7rem] font-black tracking-tighter mb-1 italic text-white uppercase truncate drop-shadow-2xl leading-none text-right tracking-tighter leading-none text-right text-right text-right">
                          {inspecting.name}
                        </h3>
                        <span className="text-indigo-400 font-mono text-3xl uppercase tracking-[0.8em] font-black block leading-none text-right italic text-right text-right text-right uppercase tracking-[1em] leading-none">
                          {inspecting.role}
                        </span>
                      </div>
                    </div>
                    <div className="space-y-20 text-right text-right text-right text-right text-right">
                      <div className="text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right">
                        <h5 className="text-sm text-slate-800 uppercase font-black tracking-[1em] mb-10 pr-6 italic border-r-[10px] border-indigo-600 px-10 leading-none text-right text-right text-right text-right text-right">
                          Core Area
                        </h5>
                        <p className="text-[4rem] font-light italic text-white leading-none tracking-tighter drop-shadow-lg uppercase leading-none text-right text-right text-right uppercase italic text-right leading-none tracking-tighter">
                          {inspecting.dept}
                        </p>
                      </div>
                      <div className="text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right">
                        <h5 className="text-sm text-slate-800 uppercase font-black tracking-[1em] mb-10 pr-6 italic border-r-[10px] border-indigo-600 px-10 leading-none text-right text-right text-right text-right text-right">
                          Neural Biography
                        </h5>
                        <p className="text-slate-400 text-3xl leading-relaxed font-light tracking-tight pr-10 border-l border-white/5 italic text-right text-right text-right italic text-right text-right leading-relaxed">
                          {inspecting.bio ||
                            "این واحد در حال مانیتورینگ لایه ۱ هسته کوانتومی در فضای ابری است."}
                        </p>
                      </div>
                      <button
                        onClick={() => setInspecting(null)}
                        className="w-full py-12 bg-white text-black rounded-[5rem] font-black text-2xl hover:scale-[1.03] transition-all shadow-xl active:scale-95 border-b-[20px] border-slate-300 italic active:border-b-0 uppercase tracking-widest leading-none text-center shadow-[0_20px_40px_rgba(255,255,255,0.1)] text-center text-center uppercase tracking-widest leading-none"
                      >
                        Dismiss Interface
                      </button>
                    </div>
                  </motion.div>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        );
      }

      // ATOM COMPONENTS
      function NavItem({ active, icon, label, onClick }) {
        return (
          <button
            onClick={onClick}
            className={`w-full flex flex-row-reverse items-center gap-5 px-7 py-5 rounded-[1.8rem] transition-all duration-700 relative group ${active ? "bg-white text-black shadow-2xl scale-[1.05] z-10 font-black" : "text-slate-600 hover:text-white hover:bg-white/[0.04] font-bold"} text-right`}
          >
            {active && (
              <motion.div
                layoutId="nav-bg"
                className="absolute inset-0 bg-white rounded-[1.8rem] -z-10 shadow-inner"
              />
            )}
            <Icon
              name={icon}
              className={
                active
                  ? "text-black text-center"
                  : "text-slate-600 group-hover:text-indigo-400 text-center"
              }
            />
            <span className="text-[11px] font-black uppercase tracking-[0.3em] leading-none italic uppercase text-right text-right uppercase tracking-[0.3em] leading-none">
              {label}
            </span>
          </button>
        );
      }

      function HeaderMetric({ label, value, color }) {
        return (
          <div className="flex flex-row-reverse items-center gap-3 px-5 py-2 bg-black/[0.2] rounded-full border border-white/[0.04] shadow-inner group cursor-help text-right text-right">
            <div
              className={`w-2 h-2 rounded-full ${color.replace("text", "bg")} shadow-[0_0_12px_currentColor] group-hover:scale-150 transition-transform`}
            />
            <div className="flex flex-row-reverse gap-2 text-[10px] font-black uppercase tracking-[0.5em] italic text-right text-right text-right text-right">
              <span className="text-slate-800 text-right">{label}:</span>
              <span className="text-white text-right">{value}</span>
            </div>
          </div>
        );
      }

      function HeaderStatus({ label, value, color }) {
        return (
          <div className="flex flex-row-reverse items-center gap-3 px-5 py-2 bg-white/[0.01] rounded-full border border-white/[0.05] shadow-inner transition-all hover:bg-white/[0.03] text-right text-right">
            <div
              className={`w-1.5 h-1.5 rounded-full ${color.replace("text", "bg")} shadow-[0_0_12px_currentColor] animate-pulse`}
            />
            <div className="flex flex-row-reverse gap-2 text-[10px] font-black uppercase tracking-[0.5em] italic leading-none text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right">
              <span className="text-slate-700 text-right">{label}:</span>
              <span className="text-white drop-shadow-xl text-right leading-none uppercase">
                {value}
              </span>
            </div>
          </div>
        );
      }

      function StatCard({ icon, label, value, sub, color }) {
        const colors = {
          indigo: "bg-indigo-600",
          emerald: "bg-emerald-600",
          fuchsia: "bg-fuchsia-600",
          orange: "bg-orange-600",
        };
        return (
          <GlassCard className="p-10 relative overflow-hidden group border-white/[0.01] text-right text-right text-right text-right">
            <div
              className={`absolute top-0 right-0 w-32 h-32 opacity-[0.04] blur-[50px] rounded-full group-hover:opacity-[0.15] transition-all duration-[1s] ${colors[color]}`}
            />
            <div className="flex flex-row-reverse items-center gap-8 text-right text-right text-right text-right text-right leading-none uppercase">
              <div className="p-6 bg-black/90 rounded-[2.5rem] border border-white/[0.06] text-slate-800 group-hover:text-white group-hover:scale-110 transition-all duration-700 shadow-3xl flex items-center justify-center border-b-4 border-white/5 flex items-center justify-center text-center shadow-[0_20px_40px_rgba(0,0,0,0.5)]">
                {typeof icon === "string" ? (
                  <Icon name={icon} size={36} />
                ) : (
                  icon
                )}
              </div>
              <div className="text-right flex-1 overflow-hidden leading-none text-right text-right uppercase tracking-widest text-right text-right text-right text-right text-right leading-none">
                <div className="text-[11px] font-black text-slate-700 uppercase tracking-[0.5em] mb-2 italic leading-none text-right uppercase tracking-widest text-right text-right text-right text-right text-right uppercase italic">
                  {label}
                </div>
                <div className="text-[4rem] font-black tracking-tighter text-white leading-none italic group-hover:translate-x-[-12px] transition-transform duration-700 drop-shadow-2xl leading-none text-right tracking-tighter text-right text-right text-right text-right text-right leading-none uppercase italic">
                  {value}
                </div>
                <div className="text-[10px] text-indigo-500 font-mono mt-4 uppercase font-black tracking-[0.4em] bg-indigo-500/5 px-4 py-1 rounded-lg inline-block border border-indigo-500/10 shadow-inner leading-none text-right italic text-right uppercase text-right text-right text-right text-right leading-none italic">
                  {sub}
                </div>
              </div>
            </div>
          </GlassCard>
        );
      }

      function IconButton({ icon, onClick, className = "" }) {
        return (
          <button
            onClick={onClick}
            className={`p-3 rounded-2xl bg-white/[0.02] border border-white/[0.05] text-slate-700 hover:text-white transition-all shadow-xl active:scale-90 hover:bg-white/5 flex items-center justify-center flex items-center justify-center text-center shadow-indigo-500/5 ${className}`}
          >
            <Icon name={icon} size={22} />
          </button>
        );
      }

      function SectionHeader({ title, subtitle, icon }) {
        return (
          <div className="mb-20 group text-right px-4 text-right text-right text-right text-right text-right text-right text-right">
            <div className="flex flex-row-reverse items-center gap-8 mb-3 leading-none text-right text-right text-right text-right text-right text-right text-right">
              {icon && (
                <div className="p-5 bg-white text-black rounded-[2.5rem] shadow-[0_20px_50px_rgba(255,255,255,0.25)] group-hover:rotate-[360deg] transition-transform duration-[1.5s] flex items-center justify-center shadow-white/5 border-b-[10px] border-slate-200 shadow-2xl flex items-center justify-center text-center shadow-[0_20px_40px_rgba(255,255,255,0.1)]">
                  <Icon name={icon} size={40} />
                </div>
              )}
              <h2 className="text-[7rem] font-black tracking-tighter uppercase italic text-white drop-shadow-2xl leading-none text-right tracking-tighter leading-none underline decoration-white decoration-[16px] underline-offset-[20px] decoration-double drop-shadow-2xl uppercase italic text-right text-right text-right text-right text-right text-right text-right text-right tracking-tighter leading-none">
                {title}
              </h2>
            </div>
            <p className="text-slate-600 text-2xl font-light tracking-[0.6em] uppercase pr-4 italic border-r-8 border-white/5 leading-none text-right mt-12 italic tracking-widest text-right uppercase text-right text-right text-right text-right text-right text-right text-right text-right leading-none italic">
              {subtitle}
            </p>
          </div>
        );
      }

      function LuxuryTitle({ title, sub, icon }) {
        return (
          <div className="mb-14 group text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right">
            <div className="flex flex-row-reverse items-center gap-6 mb-2 leading-none text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right">
              {icon && (
                <div className="p-4 bg-white text-black rounded-2xl shadow-[0_15px_40px_rgba(255,255,255,0.2)] group-hover:rotate-[360deg] transition-transform duration-1000 flex items-center justify-center shadow-white/10 border-b-4 border-slate-200 shadow-2xl flex items-center justify-center text-center">
                  <Icon name={icon} size={28} />
                </div>
              )}
              <h2 className="text-6xl font-black tracking-tight uppercase italic text-white drop-shadow-2xl leading-none text-right tracking-tighter uppercase italic text-right leading-none tracking-tighter text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right tracking-tighter leading-none">
                {title}
              </h2>
            </div>
            <p className="text-slate-600 text-[11px] font-black tracking-[0.8em] uppercase pr-2 italic leading-none text-right opacity-50 italic tracking-widest text-right uppercase text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right leading-none">
              {sub}
            </p>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<OmniSovereignApp />);
    </script>
  </body>
</html>
